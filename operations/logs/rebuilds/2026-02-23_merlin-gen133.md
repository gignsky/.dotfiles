# NixOS Rebuild Log - Merlin Generation 133

**Stardate**: 2026-02-23  
**Host**: merlin  
**Branch**: main  
**Generation**: 132 → 133  
**Build Duration**: 33 seconds  
**Status**: ✅ SUCCESS

## Configuration Analysis

**Configuration Changes Detected**:
- flake.nix
- home/gig/common/core/opencode.nix
- hosts/common/optional/bootloader.nix (DELETED)
- hosts/merlin/default.nix

## Key Changes Summary

### 1. Hostname Awareness System (flake.nix)
**Rationale**: Pass explicit hostname to home-manager configurations for host-specific resource paths

**Changes**:
- Added `hostname = "wsl";` to wsl home-manager extraSpecialArgs
- Added `hostname = "spacedock";` to spacedock home-manager extraSpecialArgs
- Added `hostname = "merlin";` to merlin home-manager extraSpecialArgs
- Added `hostname = "ganoslal";` to ganoslal home-manager extraSpecialArgs

**Technical Impact**: Enables home-manager modules to access hostname directly without system context gymnastics. Critical for SOPS secret path differentiation and agent configuration variations.

### 2. Host-Specific SOPS Secrets (opencode.nix)
**Rationale**: Different OpenCode authentication tokens per host for security and auditability

**Changes**:
```diff
- sops.secrets."opencode-auth-json" = {
+ sops.secrets."opencode-auth/${hostname}" = {
```

**Security Enhancement**:
- Each host now uses its own authentication token from SOPS secrets
- Path format: `opencode-auth/merlin`, `opencode-auth/wsl`, etc.
- Allows token revocation per-host without affecting other machines
- Better audit trail for which host accessed what resources

### 3. Agent Name Correction (opencode.nix)
**Changes**:
- Fixed agent reference from `majel` to `library-computer` in documentation
- Updated agent configuration path: `/home/gig/local_repos/annex/agent-config/library-computer-personality.md`
- Maintains consistency with fleet naming conventions

**Context**: Reflects the agent's proper designation as the Library Computer system stationed in the annex repository.

### 4. Bootloader Abstraction Removal
**Deleted File**: `hosts/common/optional/bootloader.nix`

**Rationale**: The abstraction layer provided minimal value and added complexity:
- Only used by one or two hosts
- Simpler to configure bootloader directly in host-specific configurations
- Reduces indirection and makes bootloader setup more transparent
- Eliminates unused systemd-boot abstraction code

### 5. GRUB Dual-Boot Configuration (hosts/merlin/default.nix)
**Rationale**: Merlin is a dual-boot system (NixOS + Windows) requiring proper OS detection

**Changes**:
```diff
- systemd-boot.enable = true;
+ systemd-boot.enable = false;
+ grub = {
+   enable = true;
+   device = "nodev"; # UEFI system
+   efiSupport = true;
+   efiInstallAsRemovable = false;
+   useOSProber = true; # Detect Windows and other OSes
+   configurationLimit = 20; # Show last 20 generations
+ }
```

**Technical Details**:
- **GRUB over systemd-boot**: Required for proper multi-OS detection
- **OS Prober**: Automatically detects Windows and other operating systems
- **EFI Support**: Modern UEFI boot setup (not legacy BIOS)
- **Configuration Limit**: Prevents boot menu clutter, keeps last 20 NixOS generations
- **Not Removable**: Properly installed to EFI variables (not fallback mode)

### 6. Tailscale Enablement (hosts/merlin/default.nix)
**Change**: `tailscale.enable = false;` → `tailscale.enable = true;`

**Impact**: Merlin now joins the fleet's mesh VPN network for secure inter-host communication.

### 7. Nix Secrets URL Preparation (flake.nix)
**Change**: Added commented-out local file URL for nix-secrets
```nix
# url = "git+file:///home/gig/nix-secrets/";
```

**Purpose**: Development/testing shortcut for working with secrets locally before pushing to remote repository.

## Build Metrics

- **Build Time**: 33 seconds ⚡
- **Performance**: Fast configuration-only rebuild, no package recompilation
- **Previous Generation**: 132
- **New Generation**: 133
- **Generation Jump**: Single generation increment (normal incremental update)

## Engineering Notes

### Hostname Awareness Architecture
This rebuild introduces a critical architectural improvement: **explicit hostname passing to home-manager configurations**. Previously, determining the current hostname within home-manager required complex workarounds or importing system configuration. Now it's cleanly passed as `extraSpecialArgs`, making it available to all home-manager modules.

This pattern enables:
- Host-specific SOPS secret paths
- Conditional feature enablement based on hostname
- Agent personality variations per host
- Host-aware logging and debugging

### SOPS Security Improvement
The shift from a single `opencode-auth-json` secret to per-host secrets (`opencode-auth/${hostname}`) is a significant security enhancement:

1. **Token Isolation**: Compromise of one host's token doesn't expose others
2. **Selective Revocation**: Can revoke/rotate tokens per-host without affecting fleet
3. **Audit Trail**: Clear tracking of which host uses which authentication
4. **Compliance**: Supports security policies requiring per-device credentials

### Bootloader Architecture Decision
Removing the `bootloader.nix` abstraction reflects a pragmatic engineering decision:

**Why Remove It?**
- Only merlin and potentially one other host needed it
- Added indirection without sufficient value
- Made bootloader configuration less obvious to future maintainers
- The abstraction didn't handle enough edge cases to justify complexity

**Better Approach**: Direct bootloader configuration in host-specific files with clear comments explaining choices.

### GRUB vs systemd-boot Trade-offs

**Why GRUB for Merlin?**
- **OS Prober**: Automatic Windows detection essential for dual-boot
- **Flexibility**: Better multi-OS support than systemd-boot
- **Maturity**: Well-tested dual-boot scenarios

**systemd-boot Advantages (Not Used Here)**:
- Simpler configuration
- Faster boot times
- Modern UEFI-native design
- But: Limited multi-OS detection capabilities

For single-OS NixOS systems, systemd-boot is preferable. For dual-boot systems like merlin, GRUB is the right tool.

## Technical Context

- **Repository**: /home/gig/.dotfiles
- **Branch**: main
- **Flake Target**: merlin
- **NixOS Generation**: 132 → 133
- **Home Manager**: Configuration updated (hostname awareness)
- **Pre-commit Hooks**: Not triggered (direct rebuild)
- **Configuration Drift**: None (intentional changes)

## Host-Specific Configuration

### Merlin System Profile
- **Type**: Physical workstation
- **Boot**: UEFI with GRUB
- **OS Setup**: Dual-boot NixOS + Windows
- **Networking**: Tailscale enabled
- **Role**: Primary development workstation
- **OpenCode Auth**: Host-specific SOPS secret at `opencode-auth/merlin`

### Current Bootloader Settings
```nix
boot.loader = {
  systemd-boot.enable = false;
  grub = {
    enable = true;
    device = "nodev";              # UEFI installation
    efiSupport = true;              # EFI system partition
    efiInstallAsRemovable = false;  # Proper EFI variable installation
    useOSProber = true;             # Detect Windows
    configurationLimit = 20;        # Boot menu generations limit
  };
  efi.canTouchEfiVariables = true;
};
```

## Fleet Integration Notes

### Hostname Standardization
All four fleet hosts now receive explicit hostname parameters:
- **wsl**: Development environment in Windows Subsystem for Linux
- **spacedock**: [Role to be documented]
- **merlin**: Primary workstation, dual-boot system
- **ganoslal**: [Role to be documented]

### Agent Configuration Impact
The `library-computer` agent stationed in the annex repository now has consistent naming across all documentation and configuration. This supports proper Expedition of Consultation protocols when agents interact cross-repository.

### Security Posture
Per-host authentication secrets improve overall fleet security stance. Each host can be individually credentialed and revoked without fleet-wide impact.

## Testing & Validation

**Post-Rebuild Checks**:
- [x] System boots successfully
- [x] GRUB menu displays correctly
- [x] Windows OS detected in GRUB menu
- [x] Tailscale service starts and connects
- [x] OpenCode authentication works with host-specific secret
- [x] No unexpected service failures
- [x] Build completed in reasonable time (33s)

## Future Considerations

### Potential Improvements
1. **Dynamic Generation Limits**: Could adjust `configurationLimit` based on disk space
2. **Wallpaper Rotation**: Outstanding TODO from previous logs about automated rotation
3. **Boot Menu Themes**: Consider customizing GRUB theme for fleet branding
4. **Windows Detection Validation**: Monitor OS prober effectiveness across Windows updates

### Monitoring Points
- SOPS secret path migration: Ensure all hosts have proper secrets in new path format
- GRUB OS detection: Verify Windows remains detected after Windows updates
- Tailscale connectivity: Monitor mesh network stability on merlin
- Boot time: Track whether GRUB impacts boot performance vs systemd-boot

## Related Changes

This rebuild coordinates with fleet-wide hostname awareness initiative. Future rebuilds of wsl, spacedock, and ganoslal should follow similar patterns for SOPS secret paths and OpenCode configuration.

---

**Chief Engineer**: Montgomery Scott  
**Log Entry**: Hostname awareness, SOPS security enhancement, and dual-boot GRUB configuration  
**Fleet Status**: Operational, Merlin Generation 133 running optimally  
**Next Actions**: Monitor SOPS secret paths on other hosts, validate Windows detection persistence  
**Notable**: Bootloader abstraction removed in favor of direct configuration clarity
