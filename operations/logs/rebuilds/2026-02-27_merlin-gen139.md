# Home-Manager Rebuild Log - Merlin Generation 139

**Stardate**: 2026-02-27  
**Host**: merlin  
**Branch**: fixing-fucked-fonts  
**Generation**: 138 → 139 (Home-Manager)  
**Build Duration**: 16 seconds  
**Status**: ✅ SUCCESS

## Configuration Analysis

**Configuration Changes Detected**:
- home/gig/common/optional/bspwm.nix
- home/gig/common/optional/picom.nix
- home/gig/common/optional/polybar.nix

## Key Changes Summary

### 1. Picom Compositor Configuration Extraction (NEW FILE)
**Rationale**: Proper declarative management of window compositor configuration
- Created dedicated `picom.nix` module for centralized compositor settings
- Extracted compositor launch logic from polybar's bspwm extraConfig
- Follows home-manager best practices for service management

**New Module Features** (`home/gig/common/optional/picom.nix`):
- **Backend**: GLX with VSync enabled for smooth rendering
- **Opacity System**:
  - Active windows: 83% opaque (0.83)
  - Inactive windows: 75% opaque (0.75)
  - Window frames: 79% opaque (0.79)
- **Application-Specific Rules**:
  - Browsers (Firefox, Chromium): 100% opaque for readability
  - Terminals (WezTerm): 83% to match active window opacity
  - Editors (VS Code): 83% for focused work
  - Media players (mpv, vlc): 100% opaque for clear video
  - Rofi launcher: 75% to match inactive windows
- **Visual Effects**:
  - Fading enabled with smooth transitions (0.03 step increments)
  - Drop shadows with 12px radius and 75% opacity
  - Dual Kawase blur (strength: 2) on active windows only
  - Excludes blur from inactive windows for performance and clarity
- **Performance Optimizations**:
  - Damage tracking enabled (`use-damage = true`)
  - Client opacity detection for better rendering
  - Transient window detection for proper stacking

### 2. Compositor Service Migration (polybar.nix)
**Change**: Removed manual picom launch from bspwm extraConfig
- **Removed**: Shell command `picom --backend glx -b &` from polybar configuration
- **Rationale**: Declarative service management is more reliable than manual launch
- **Benefits**:
  - Automatic restart on crashes via systemd
  - Proper dependency ordering with other services
  - Configuration changes applied through home-manager rebuilds
  - No shell command duplication or race conditions

### 3. Module Import Chain (bspwm.nix)
**Change**: Added picom.nix to bspwm imports
- Now imports both polybar and picom modules
- Ensures compositor is available for bspwm environments
- Maintains modular configuration structure

## Build Metrics

- **Build Time**: 16 seconds ⚡
- **Performance**: Lightning fast - service configuration only, no package rebuilds
- **Previous Generation**: 138
- **New Generation**: 139
- **Rebuild Type**: Home-Manager only (no NixOS system changes)

## Engineering Notes

This rebuild represents a significant architectural improvement in how the compositor is managed. Previously, picom was launched via a shell command embedded in the polybar bspwm extraConfig section - a common but suboptimal pattern. The new approach leverages home-manager's built-in `services.picom` module, which provides:

1. **Declarative Configuration**: All picom settings defined in Nix, making them version-controlled and reproducible
2. **Service Management**: Systemd integration for automatic restart and proper lifecycle management
3. **Type Safety**: Nix attribute validation catches configuration errors at build time
4. **Modularity**: Picom configuration is now in its own module, following single-responsibility principle

**Opacity Philosophy**: The chosen opacity values (83%/75%/79%) strike a balance between visual aesthetics and readability. Application-specific rules ensure critical interfaces (browsers, media players) remain fully opaque while terminals and editors benefit from subtle transparency that can show underlying content without compromising legibility.

**Blur Strategy**: Applying blur only to active windows serves dual purposes - it draws attention to the focused window while keeping inactive windows sharper for peripheral monitoring. The Dual Kawase method with strength 2 provides gentle blur without the performance cost of stronger effects.

**Performance Considerations**: The configuration explicitly excludes desktop, dock, and unfocused windows from blur effects, maintaining smooth performance even on systems with many windows. The `use-damage` setting enables intelligent repainting, reducing GPU load.

## Technical Context

- **Repository**: /home/gig/.dotfiles
- **Working Branch**: fixing-fucked-fonts
- **Flake Target**: merlin (home-manager only)
- **NixOS Generation**: 1 (unchanged)
- **Home-Manager Generation**: 138 → 139
- **Service Changes**: Added picom.service to user systemd target
- **Configuration Drift**: Intentional architectural improvement

## Configuration Impact

**Files Created**:
```
+ home/gig/common/optional/picom.nix (76 lines, comprehensive compositor config)
```

**Files Modified**:
```
~ home/gig/common/optional/bspwm.nix (+1 import line)
~ home/gig/common/optional/polybar.nix (-8 lines, removed manual picom launch)
```

**Net Change**: +69 lines of declarative configuration replacing 8 lines of imperative shell commands

## User Experience Improvements

1. **Visual Aesthetics**: Transparent windows with subtle blur create modern desktop appearance
2. **Focus Indication**: Active window is more opaque and blurred, clearly indicating focus
3. **Readability**: Application-specific rules ensure text-heavy apps remain clear
4. **Smooth Transitions**: Fade effects provide polished window state changes
5. **Performance**: Optimized blur exclusions maintain responsiveness

## Testing Recommendations

After this rebuild, verify:
- [ ] Picom service starts automatically on login (`systemctl --user status picom`)
- [ ] Window opacity matches configured values (active vs inactive windows)
- [ ] Application-specific opacity rules work (Firefox, WezTerm, etc.)
- [ ] Blur effect appears on active windows only
- [ ] No performance degradation with multiple windows
- [ ] Shadow rendering appears correctly on all window types
- [ ] Fade transitions are smooth during window focus changes

## Fleet Integration Notes

This compositor configuration is specific to graphical environments (bspwm) and demonstrates proper service modularization. The pattern used here - extracting imperative shell commands into declarative service modules - should be applied to other manual launch commands throughout the fleet's configurations.

**Reusability**: The picom.nix module can be imported by any host configuration that uses a window manager requiring compositor support. The opacity and blur settings can be overridden per-host if different visual preferences are desired.

---

**Chief Engineer**: Montgomery Scott  
**Log Entry**: Compositor configuration extraction and service management improvement  
**Fleet Status**: Operational, Merlin running Home-Manager Generation 139 with declarative picom service  
**Next Actions**: Monitor compositor performance and visual quality; consider applying similar service extraction to other manual launch patterns
